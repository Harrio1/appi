# Инструкция по настройке мобильного приложения и сервера

## Описание

Эти скрипты автоматизируют настройку CORS и IP-адресов для мобильного приложения и сервера API. Они позволяют быстро адаптировать приложение при изменении IP-адресов или переносе на другое устройство.

## Что делают скрипты

1. **setup-cors.js** - настраивает CORS и IP для серверной части:
   - Определяет доступные IP-адреса на устройстве
   - Позволяет выбрать IP-адрес сервера
   - Настраивает CORS для разрешения запросов с указанного мобильного клиента
   - Обновляет настройки сервера в файле mobile-server.js
   - Создает файлы запуска сервера (bat и ps1)

2. **setup-mobile-client.js** - настраивает мобильное приложение:
   - Создает .env.local файл с адресом API
   - Обновляет/создает конфигурацию API в приложении
   - Создает файлы запуска клиента на нужном IP-адресе

3. **start-setup.bat** - запускает оба скрипта настройки последовательно

## Как использовать

### Вариант 1: Автоматическая настройка

1. Запустите файл `start-setup.bat`
2. Следуйте инструкциям в командной строке
3. После завершения настройки используйте созданные файлы запуска

### Вариант 2: Настройка по отдельности

#### Настройка сервера:
```
node setup-cors.js
```

#### Настройка мобильного клиента:
```
node setup-mobile-client.js
```

## Что ввести при настройке

- **IP-адрес сервера** - IP-адрес, на котором будет запущен API-сервер
- **IP-адрес мобильного клиента** - IP-адрес, с которого будут отправляться запросы
- **Порт сервера** - порт для API-сервера (по умолчанию 8000)
- **Порт мобильного приложения** - порт для клиента (по умолчанию 3000)

## Созданные файлы

После выполнения скриптов вы получите:

- Обновленный файл mobile-server.js с настройками CORS
- Файлы для запуска сервера: `start-mobile-[IP].bat` и `start-mobile-[IP].ps1`
- Файл .env.local в папке мобильного приложения
- Файлы для запуска клиента: `start-[IP].bat` и `start-[IP].ps1`

## Требования

- Node.js
- Доступ к файловой системе для создания и изменения файлов

## Пошаговая инструкция по изменению IP-адреса

### 1. Определение нового IP-адреса

Перед изменением конфигурации вам нужно знать новый IP-адрес вашего устройства. Вы можете узнать его, выполнив:

В Windows:
```
ipconfig
```

В Linux/macOS:
```
ifconfig
```
или
```
ip addr
```

### 2. Запуск скрипта настройки

```bash
# Перейдите в директорию с проектом
cd C:\laragon\www\appi\map

# Запустите скрипт настройки
node setup-cors.js
```

Вам будут предложены следующие параметры:
- IP-адрес сервера (введите новый IP)
- IP-адрес мобильного клиента (обычно тот же, что и сервер)
- Порт сервера (обычно 8000)

### 3. Настройка мобильного клиента

```bash
# Перейдите в директорию клиента
cd C:\laragon\www\appi\mobile-app

# Запустите скрипт настройки
node setup-mobile-client.js
```

### 4. Проверка конфигурации

После настройки проверьте, что IP-адреса корректно изменены в следующих файлах:

#### Файлы сервера
- `map/mobile-server.js`: проверьте CORS настройки и IP-адрес в app.listen
- Убедитесь, что созданы файлы `start-mobile-[IP].bat` и `start-mobile-[IP].ps1`

#### Файлы клиента
- `mobile-app/.env.local`: должен содержать новый API URL
- `mobile-app/src/utils/apiConfig.js`: должен содержать новый IP-адрес
- `mobile-app/package.json`: скрипты запуска должны использовать новый IP

### 5. Запуск приложения

1. Запустите сервер API:
```
cd C:\laragon\www\appi\map
.\start-mobile-[IP].bat
```

2. Запустите мобильное приложение:
```
cd C:\laragon\www\appi\mobile-app
.\start-[IP].bat
```

### 6. Проверка соединения

В браузере откройте консоль разработчика (F12) и проверьте, что нет ошибок CORS или timeout.

Вы также можете проверить работоспособность API, выполнив:
```
curl http://[IP]:8000/api/health
```

## Решение проблем

Если после настройки проблемы с CORS остаются:

1. Перезапустите и сервер, и клиент
2. Убедитесь, что вы используете правильные IP-адреса
3. Проверьте, что порты не заблокированы брандмауэром
4. Проверьте, что клиент использует правильный URL для API

### Типичные ошибки и их решения

#### 1. Error: listen EADDRNOTAVAIL
Ошибка означает, что указанный IP-адрес недоступен на устройстве.
**Решение**: Проверьте доступные IP-адреса с помощью ipconfig и используйте один из них.

#### 2. Ошибки CORS
```
Access to XMLHttpRequest has been blocked by CORS policy
```
**Решение**: Убедитесь, что IP-адрес клиента указан в опциях CORS на сервере.

#### 3. Timeout ошибки
```
timeout of 5000ms exceeded
```
**Решение**: 
- Проверьте, что сервер запущен
- Увеличьте значение таймаута в файле apiConfig.js
- Проверьте сетевое соединение между клиентом и сервером

#### 4. Ошибка "Cannot find module"
**Решение**: Убедитесь, что вы находитесь в правильной директории при запуске скриптов.

## Дополнительные рекомендации

1. При частой смене IP-адресов рекомендуется использовать автоматические скрипты вместо ручного редактирования файлов.

2. Для стабильного тестирования рекомендуется настроить статический IP-адрес на устройстве.

3. При развертывании в продакшене рекомендуется настроить DNS-имя вместо IP-адреса. 